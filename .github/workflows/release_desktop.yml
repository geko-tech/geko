name: Release GekoDesktop
on:
  workflow_dispatch:

jobs:
  build_desktop:
    name: Build GekoDesktop
    runs-on: macos-26
    permissions:
      contents: write
    env:
      BUILD_DIR: "GekoDesktop/build_output"
      VERSION_FILE: GekoDesktop/GekoDesktop/Sources/Support/Constants/Constants.swift
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Fetch last tag
        run: |
          git fetch --tags

          LATEST_TAG=$(git tag -l "Desktop@*" --sort=-version:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            echo "Latest tag not found" >&2; exit 1;
          fi
          echo $LATEST_TAG
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
      - name: Calculate new version
        id: bump_type
        run: |
          LATEST_TAG="${{ env.LATEST_TAG }}"

          LATEST_VERSION=$(echo "$LATEST_TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          if [ -n "$LATEST_VERSION" ]; then
            LATEST_VERSION="${LATEST_VERSION}"
          else
            echo "Failed to extract version from tag: $LATEST_TAG" >&2; exit 1;
          fi

          all_messages=$(git log "$LATEST_TAG"..HEAD --format=%B | grep -Ei "desktop \[(patch|minor|major)\] .*" | sed 's/desktop/â€¢/g')
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$all_messages" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo $all_messages
          chmod +x ./scripts/utils/incr_semver.sh

          NEW_BUMP_TYPE=""
          NEW_VERSION=""
          if [[ "$all_messages" == *"[major]"* ]]; then
          NEW_BUMP_TYPE="major"
          NEW_VERSION=$(./scripts/utils/incr_semver.sh "$LATEST_VERSION" major)
          elif [[ "$all_messages" == *"[minor]"* ]]; then
          NEW_BUMP_TYPE="minor"
          NEW_VERSION=$(./scripts/utils/incr_semver.sh "$LATEST_VERSION" minor)
          else
          NEW_BUMP_TYPE="patch"
          NEW_VERSION=$(./scripts/utils/incr_semver.sh "$LATEST_VERSION" patch)
          fi
          echo "bump_type is $NEW_BUMP_TYPE"
          echo "NEW_BUMP_TYPE=$NEW_BUMP_TYPE" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Setup committer
        run: |
          git config user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Install Xcodegen
        run: brew install xcodegen

      - name: Build Release Binary
        run: |
          NEW_VERSION="${{ env.NEW_VERSION }}"
          sed -i '' -E 's|let appVersion = "[0-9.]*"|let appVersion = \"'"$NEW_VERSION"'\"|' $VERSION_FILE

          (cd GekoDesktop && xcodegen generate)
          fastlane gym \
            --project "GekoDesktop/GekoDesktop.xcodeproj" \
            --scheme GekoDesktop \
            --export_method mac-application \
            --output_directory "$BUILD_DIR" \
            --destination "platform=macOS" \
            --xcargs "-skipPackagePluginValidation" \
            --clean true \
            --xcodebuild_formatter xcbeautify

          (cd $BUILD_DIR && zip -r ../../GekoDesktop.app.zip GekoDesktop.app)

      - name: Commit changes
        id: commit_bump_version
        run: |
          git pull
          NEW_VERSION="${{ env.NEW_VERSION }}"
          ALL_MESSAGES="${{ env.CHANGELOG }}"
          FILE="Desktop_Changelog.md"
          TEMP_FILE="temp.md"
          NEW_CONTENT="## Desktop $NEW_VERSION
          $ALL_MESSAGES
          "
          if grep -q "Desktop $NEW_VERSION" "$FILE"; then
            echo "The file '$FILE' contains new changes"
          else
            echo "$NEW_CONTENT" > "$TEMP_FILE"
            cat "$FILE" >> "$TEMP_FILE"
            mv "$TEMP_FILE" "$FILE"
          fi
    
          git add $VERSION_FILE
          git add $FILE
          git commit -m "Bump GekoDesktop app version to $NEW_VERSION"
          git push

      - name: Add tag
        run: |
          NEW_VERSION="${{ env.NEW_VERSION }}"
          NEW_TAG="Desktop@$NEW_VERSION"
          if git ls-remote --exit-code --tags origin "$NEW_TAG"; then
            echo "Tag $NEW_TAG found."
          else
            echo "Tag $NEW_TAG not found. Creating..."
            git tag $NEW_TAG
            git push origin $NEW_TAG
          fi

      - name: Create draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ env.NEW_VERSION }}"
          NEW_TAG="Desktop@$NEW_VERSION"
          COMMIT_SHA=$(git rev-parse HEAD)
          gh release create $NEW_TAG -d --title $NEW_TAG --notes "${{ env.CHANGELOG }}" --target $COMMIT_SHA GekoDesktop.app.zip